<!DOCTYPE html>
<html>

<head>
    <title>arcgis map temperature</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <!-- <link rel="stylesheet" href="https://js.arcgis.com/3.23/esri/css/esri.css"> -->
    <link rel="stylesheet" href="http://localhost/arcgis_js_api/library/3.27/3.27/esri/css/esri.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        #mapCanvas {
            padding: 0;
            height: 100%;
        }
    </style>
    <script type="text/javascript">
        dojoConfig = {
            parseOnLoad: true,
            packages: [{
                name: 'extend',
                location: this.location.pathname.replace(/\/[^/]+$/, "") + "/plugins"
            }]
        };
    </script>
    <script type="text/javascript" src="../build/arcgis-map-temperature.js"></script>
    <!-- <script src="https://js.arcgis.com/3.23/"></script> -->
    <script type="text/javascript" src="http://localhost/arcgis_js_api/library/3.27/3.27/init.js"></script>
</head>

<body>
    <div id="mapCanvas">
    </div>
    <div id='tooltips'
        style="position: absolute; visibility: hidden; background-color: rgba(0, 0, 0, 0.7); transition: top 0.2s ease 0s, left 0.2s ease 0s; border-radius: 2px; color: rgb(255, 255, 255); line-height: 16px; padding: 5px 10px; left: 137px; top: 337.333px;">
        2019-9-8<br>AQI
        : 102<br><span
            style="display:inline-block;margin-right:5px;border-radius:10px;width:9px;height:9px;background-color:rgba(197, 233, 0, 1);"></span>轻度污染
    </div>
    <script>
        var map, baseLayer, animateLayer, temperature;
        require([
            "esri/map",
            "dojo/parser",
            "dojo/number",
            "dojo/json",
            "dojo/request",
            "esri/geometry/Point",
            "extend/RasterLayer",
            "dojo/domReady!"
        ], function (Map, parser, number, JSON, request, Point, RasterLayer) {
            parser.parse();
            map = new Map("mapCanvas", {
                center: [81, 41.9],
                zoom: 6,
                basemap: "gray"
            });

            map.on("load", mapLoaded);

            function mapLoaded() {
                baseLayer = new RasterLayer(null, {
                    opacity: 1
                });
                middleLayer = new RasterLayer(null, {
                    opacity: 1
                });
                animateLayer = new RasterLayer(null, {
                    opacity: 1
                });
                map.addLayers([baseLayer, middleLayer, animateLayer]);
                map.on("extent-change", redraw);
                map.on("resize", redraw);
                map.on("zoom-start", redraw);
                map.on("pan-start", redraw);

                request.get('data/2019032412_2019032516-fsp-surface-level-wrf-27km.json', {
                    handleAs: "json"
                }).then(function (res) {
                    var result = res[0],
                        matrixData = [],
                        idx = 0,
                        nx = result.header.nx, //x方向网格数
                        ny = result.header.ny, //y方向网格数
                        dx = result.header.dx / 1000, //经度间隔度数
                        dy = result.header.dy / 1000, //纬度间隔度数
                        lonMin = result.header.lo1, //最小经度
                        lonMax = result.header.lo2, //最大经度
                        latMin = result.header.la2, //最小纬度
                        latMax = result.header.la1; //最大纬度

                    for (let y = 0; y < ny; y++) {
                        var row = [],
                            lat = (latMax * 10 - y * dy * 10) / 10; //避免加减算法不准确
                        for (let x = 0; x < nx; x++) {
                            row.push({
                                point: new Point({
                                    x: (lonMin * 10 + x * dx * 10) / 10,
                                    y: lat,
                                    spatialReference: {
                                        wkid: 4326
                                    }
                                }),
                                value: result.data[idx]
                            });
                            idx++;
                        }
                        matrixData.push(row);
                    }

                    temperature = new Temperature(map, {
                        size: 2,
                        color: '#F9815C',
                        data: matrixData,
                        baseCanvas: baseLayer._element,
                        animateCanvas: animateLayer._element,
                    });
                    redraw();
                    console.log(matrixData);
                }, function (e) {
                    console.log('Error: ', e.message);
                });
            }

            function redraw() {
                baseLayer._element.width = map.width;
                baseLayer._element.height = map.height;
                animateLayer._element.width = map.width;
                animateLayer._element.height = map.height;
                temperature.start();
            }
        });
    </script>
</body>

</html>